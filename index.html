<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ProjectFlow Embed</title>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --primary:#2563eb;
      --bg:#ffffff;
      --panel:#ffffff;
      --muted:#64748b;
      --text:#0f172a;
      --border:#e5e7eb;
      --shadow: 0 10px 25px rgba(15,23,42,.06);
      --shadow2: 0 4px 12px rgba(15,23,42,.08);

      --red:#ef4444;
      --orange:#f97316;
      --yellow:#f59e0b;
      --green:#22c55e;
      --bluebg:#eff6ff;
    }
    body{
      font-family:'IBM Plex Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: transparent;
      color:var(--text);
      line-height:1.5;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;border:1px solid var(--border);border-radius:16px;
      background:rgba(255,255,255,.92);box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:14px;background:var(--primary);
      display:grid;place-items:center;color:#fff;flex:0 0 auto;
    }
    .brand h1{font-family:'Sora',sans-serif;font-size:16px;line-height:1.1;margin:0}
    .brand p{font-size:12px;color:var(--muted);margin:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--border);background:#fff;color:var(--text);
      padding:9px 12px;border-radius:12px;cursor:pointer;
      font-weight:600;font-size:13px;
    }
    .tab.active{background:var(--primary);border-color:var(--primary);color:#fff}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);background:#fff;color:var(--text);
      padding:9px 12px;border-radius:12px;cursor:pointer;
      font-weight:700;font-size:13px;display:inline-flex;align-items:center;gap:8px;
    }
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn:active{transform:translateY(1px)}
    .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:14px}
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:16px;
      box-shadow:var(--shadow2);padding:14px;position:relative;
    }
    .kpi .label{font-size:12px;color:var(--muted);margin-bottom:8px}
    .kpi .value{font-family:'Sora',sans-serif;font-size:28px;font-weight:800}
    .kpi .sub{font-size:12px;color:var(--muted)}
    .pill{
      position:absolute;right:12px;top:12px;width:34px;height:34px;border-radius:14px;
      background:var(--bluebg);border:1px solid #dbeafe;color:var(--primary);
      display:grid;place-items:center;
    }
    .grid2{display:grid;grid-template-columns:1.1fr .9fr;gap:12px;margin-top:12px}
    .card h2{font-family:'Sora',sans-serif;font-size:14px;margin-bottom:10px}
    .chartBox{height:260px}
    .tableHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input,.select{
      border:1px solid var(--border);border-radius:12px;padding:9px 10px;font-size:13px;
      outline:none;background:#fff;min-width:220px;
    }
    .select{min-width:160px}
    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{
      text-align:left;color:var(--muted);font-weight:700;padding:12px 10px;
      border-bottom:1px solid var(--border);
    }
    tbody td{padding:12px 10px;border-bottom:1px solid #eef2f7;vertical-align:top}
    tr.row{cursor:pointer}
    tr.row:hover{background:#f8fafc}
    .idLink{color:var(--primary);text-decoration:none;font-weight:800}
    .desc{color:var(--muted);font-size:12px;margin-top:3px;max-width:520px}
    .tag{
      display:inline-flex;align-items:center;gap:6px;padding:4px 9px;border-radius:999px;
      font-size:12px;font-weight:700;border:1px solid transparent;white-space:nowrap;
    }
    .tag.critical{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .tag.high{background:#ffedd5;color:#9a3412;border-color:#fed7aa}
    .tag.medium{background:#fef3c7;color:#92400e;border-color:#fde68a}
    .tag.low{background:#dcfce7;color:#166534;border-color:#bbf7d0}

    .tag.status.completed{background:#dcfce7;color:#166534;border-color:#bbf7d0}
    .tag.status.inprogress{background:#fef3c7;color:#92400e;border-color:#fde68a}
    .tag.status.blocked{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .tag.status.notstarted{background:#dbeafe;color:#1e40af;border-color:#bfdbfe}
    .tag.status.onhold{background:#f3e8ff;color:#6b21a8;border-color:#e9d5ff}

    /* Tasks */
    .sectionTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .taskGrid{display:grid;gap:12px}
    .taskRow{display:flex;gap:12px;align-items:flex-start}
    .taskCheck{margin-top:3px;width:18px;height:18px;cursor:pointer}
    .taskTitle{font-weight:800;margin-bottom:3px}
    .taskTitle.done{text-decoration:line-through;color:var(--muted)}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge{
      font-size:12px;font-weight:700;padding:4px 10px;border-radius:999px;
      border:1px solid var(--border);background:#f8fafc;color:var(--text);
    }
    .badge.overdue{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .badge.today{background:#fef3c7;border-color:#fde68a;color:#92400e}
    .btnMini{
      border:1px solid var(--border);background:#fff;border-radius:12px;
      padding:7px 10px;font-weight:800;font-size:12px;cursor:pointer;
      display:inline-flex;gap:6px;align-items:center;
    }
    .btnMini:hover{border-color:#bfdbfe;background:#eff6ff}

    /* Hover tasks preview */
    .hoverWrap{position:relative}
    .hoverTasks{
      position:absolute;left:10px;right:10px;top:calc(100% - 6px);
      background:#fff;border:1px solid var(--border);border-radius:14px;
      box-shadow:var(--shadow2);padding:10px;display:none;z-index:20;
    }
    .hoverWrap:hover .hoverTasks{display:block}
    .hoverTitle{font-size:12px;font-weight:900;margin-bottom:8px}
    .hoverItem{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-top:1px solid var(--border);font-size:12px;color:var(--muted)}
    .hoverItem:first-of-type{border-top:none}
    .hoverItem strong{color:var(--text)}

    /* Modal */
    .backdrop{
      position:fixed;inset:0;background:rgba(15,23,42,.45);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:9999;
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(720px,100%);background:#fff;border:1px solid var(--border);
      border-radius:16px;box-shadow:var(--shadow);padding:16px;
    }
    .modal h3{font-family:'Sora',sans-serif;font-size:16px;margin-bottom:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted);font-weight:800;display:block;margin-bottom:6px}
    input,select{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;
    }
    .footer{display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;margin-top:12px}

    .page{display:none;margin-top:14px}
    .page.active{display:block}

    @media (max-width: 980px){
      .grid4{grid-template-columns:repeat(2,minmax(0,1fr))}
      .grid2{grid-template-columns:1fr}
      .input{min-width:100%}
      table{min-width:980px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">‚úì</div>
        <div>
          <h1>ProjectFlow</h1>
          <p>Google Sites embed</p>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Navigation">
        <button class="tab active" data-page="dashboard">Dashboard</button>
        <button class="tab" data-page="projects">Projects</button>
        <button class="tab" data-page="tasks">Tasks</button>
      </div>

      <div class="actions">
        <button class="btn" id="btnTasks"><span>‚úì</span><span>View Tasks</span></button>
        <button class="btn primary" id="btnNewProject"><span>‚ûï</span><span>New Project</span></button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section class="page active" id="dashboard-page">
      <div class="grid4">
        <div class="card kpi">
          <div class="pill" title="Total Projects">‚â°</div>
          <div class="label">Total Projects</div>
          <div class="value" id="kpiTotal">0</div>
          <div class="sub" id="kpiCompletion">0% completion rate</div>
        </div>
        <div class="card kpi">
          <div class="pill" title="Completed">‚úì</div>
          <div class="label">Completed</div>
          <div class="value" id="kpiCompleted">0</div>
          <div class="sub">Projects finished</div>
        </div>
        <div class="card kpi">
          <div class="pill" title="In Progress">‚è±</div>
          <div class="label">In Progress</div>
          <div class="value" id="kpiInProgress">0</div>
          <div class="sub">Active work</div>
        </div>
        <div class="card kpi">
          <div class="pill" title="Blocked">‚ö†</div>
          <div class="label">Blocked</div>
          <div class="value" id="kpiBlocked">0</div>
          <div class="sub">Needs attention</div>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <h2>Status Distribution</h2>
          <div class="chartBox"><canvas id="statusChart"></canvas></div>
        </div>
        <div class="card">
          <h2>Priority Breakdown</h2>
          <div class="chartBox"><canvas id="priorityChart"></canvas></div>
        </div>
      </div>

      <div class="card">
        <div class="tableHead">
          <h2 style="margin:0">All Projects</h2>
          <div class="controls">
            <input class="input" id="searchInput" placeholder="Search projects..." />
            <select class="select" id="statusFilter">
              <option value="All">All Status</option>
              <option value="Completed">Completed</option>
              <option value="In Progress">In Progress</option>
              <option value="Blocked">Blocked</option>
              <option value="Not Started">Not Started</option>
              <option value="On Hold">On Hold</option>
            </select>
          </div>
        </div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:140px">Project No.</th>
                <th>Project Name</th>
                <th style="width:150px">Category</th>
                <th style="width:90px">Priority</th>
                <th style="width:120px">Status</th>
                <th style="width:130px">Due</th>
              </tr>
            </thead>
            <tbody id="projectsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PROJECTS -->
    <section class="page" id="projects-page">
      <div class="card">
        <div class="sectionTitle">
          <div>
            <h2 style="margin:0">Projects</h2>
            <div class="muted" style="font-size:13px;margin-top:4px;">Create, edit, delete projects. Hover to preview tasks.</div>
          </div>
          <button class="btn primary" id="btnNewProject2">‚ûï New Project</button>
        </div>
      </div>

      <div style="margin-top:12px" class="taskGrid" id="projectsGrid"></div>
    </section>

    <!-- TASKS -->
    <section class="page" id="tasks-page">
      <div class="card">
        <div class="sectionTitle">
          <div>
            <h2 style="margin:0">Tasks</h2>
            <div class="muted" style="font-size:13px;margin-top:4px;" id="tasksSubtitle">Track and update your work items</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn" id="btnClearCompleted">üßπ Clear Completed</button>
            <button class="btn" id="btnShowAll" style="display:none;">‚Ü© Show All</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2 style="margin-bottom:10px">Add Task</h2>
        <form id="addTaskForm" style="display:grid;grid-template-columns:1fr 180px 260px 140px;gap:10px;align-items:end;">
          <div>
            <label>Task name</label>
            <input id="taskTitle" required placeholder="e.g., Finalize wireframes" />
          </div>
          <div>
            <label>Due date</label>
            <input id="taskDue" type="date" required />
          </div>
          <div>
            <label>Project</label>
            <select id="taskProject"></select>
          </div>
          <div>
            <button class="btn primary" type="submit" style="width:100%;justify-content:center;">‚ûï Add</button>
          </div>
        </form>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="tableHead">
          <h2 style="margin:0">Task List</h2>
          <div class="controls">
            <select class="select" id="taskFilter">
              <option value="all">All</option>
              <option value="open">Open</option>
              <option value="completed">Completed</option>
              <option value="due-today">Due Today</option>
              <option value="overdue">Overdue</option>
            </select>
          </div>
        </div>
        <div class="taskGrid" id="tasksGrid"></div>
      </div>
    </section>
  </div>

  <!-- TASK EDIT MODAL -->
  <div class="backdrop" id="taskModal">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Edit Task</h3>
      <div style="margin-bottom:10px">
        <label>Task name</label>
        <input id="tmTaskTitle" />
      </div>
      <div class="row2">
        <div>
          <label>Due date</label>
          <input id="tmDue" type="date" />
        </div>
        <div>
          <label>Project</label>
          <select id="tmProject"></select>
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="tmCancel">‚úñ Cancel</button>
        <button class="btn primary" id="tmSave">üíæ Save</button>
      </div>
    </div>
  </div>

  <!-- PROJECT MODAL -->
  <div class="backdrop" id="projectModal">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="pmTitle">New Project</h3>

      <div class="row2" style="margin-bottom:10px">
        <div>
          <label>Category</label>
          <select id="pmType">
            <option value="PRJ">PRJ (General)</option>
            <option value="GR">GR (Generation related data)</option>
            <option value="IT">IT (IT support for other departments)</option>
            <option value="AP">AP (AP-wide)</option>
          </select>
        </div>
        <div>
          <label>Project Number</label>
          <input id="pmNumber" placeholder="Auto-generated" />
        </div>
      </div>

      <div class="row2" style="margin-bottom:10px">
        <div>
          <label>Start date</label>
          <input id="pmStart" type="date" />
        </div>
        <div>
          <label>Due date</label>
          <input id="pmDue" type="date" />
        </div>
      </div>

      <div style="margin-bottom:10px">
        <label>Project name</label>
        <input id="pmName" placeholder="e.g., Website Revamp" />
      </div>

      <div class="row2" style="margin-bottom:10px">
        <div>
          <label>Department / Client</label>
          <input id="pmClient" placeholder="e.g., Finance" />
        </div>
        <div>
          <label>Status</label>
          <select id="pmStatus">
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:10px">
        <label>Description</label>
        <input id="pmDesc" placeholder="Short description" />
      </div>

      <div class="footer">
        <button class="btn" id="pmCancel">‚úñ Cancel</button>
        <button class="btn primary" id="pmSave">üíæ Save</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Storage
     ***********************/
    const LS = {
      projects: "pf_projects_embed_v1",
      tasks: "pf_tasks_embed_v1",
      seeded: "pf_seeded_embed_v1"
    };

    const defaultProjects = [
      { id: 1, type: "PRJ", projectNumber: "PRJ-2025-001", name: "E-Commerce Platform Redesign", client: "TechCorp Inc.", status: "active",
        description: "Redesign with modern UI/UX, improved performance, and mobile responsiveness.",
        startDate: "2025-01-15", dueDate: "2025-03-30"
      },
      { id: 2, type: "IT", projectNumber: "IT-001", name: "Mobile App Support Enablement", client: "Operations", status: "active",
        description: "IT support workstream for mobile initiatives and enablement.",
        startDate: "2025-01-20", dueDate: "2025-04-15"
      },
      { id: 3, type: "GR", projectNumber: "GR-001", name: "Generation Data Harmonization", client: "Data Office", status: "completed",
        description: "Standardize and harmonize generation-related datasets and definitions.",
        startDate: "2024-12-01", dueDate: "2025-01-20"
      }
    ];

    const defaultTasks = [
      { id: 101, title: "Audit product pages", projectId: 1, dueDate: "2025-02-10", completed: false },
      { id: 102, title: "Define support intake process", projectId: 2, dueDate: "2025-02-06", completed: false },
      { id: 103, title: "Publish data dictionary", projectId: 3, dueDate: "2025-01-20", completed: true }
    ];

    function loadLS(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(raw === null) return fallback;          // IMPORTANT: allow []
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      }catch{ return fallback; }
    }
    function saveLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    // Seed demo data ONLY once (so deleting all projects/tasks will stay deleted)
    function seedDefaultsOnce(){
      const seeded = localStorage.getItem(LS.seeded) === "1";
      if(seeded) return;
      saveLS(LS.projects, defaultProjects);
      saveLS(LS.tasks, defaultTasks);
      localStorage.setItem(LS.seeded, "1");
    }
    seedDefaultsOnce();

    // After seeding, load from storage; allow empty arrays
    let projects = loadLS(LS.projects, []);
    let tasks = loadLS(LS.tasks, []);

    function persist(){
      saveLS(LS.projects, projects);
      saveLS(LS.tasks, tasks);
    }

    /***********************
     * Helpers
     ***********************/
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function fmtDate(iso){
      if(!iso) return "‚Äî";
      return new Date(iso).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});
    }
    function safe(v){ return (v ?? "").toString(); }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function isDueToday(t){ return !t.completed && t.dueDate === todayISO(); }
    function isOverdue(t){ return !t.completed && t.dueDate < todayISO(); }

    function statusToLabel(p){
      // blocked if any overdue open tasks
      const hasOverdue = tasks.some(t => t.projectId === p.id && !t.completed && t.dueDate < todayISO());
      if(hasOverdue) return "Blocked";

      if(p.status === "completed") return "Completed";
      if(p.status === "active") return "In Progress";
      if(p.status === "pending") return "Not Started";
      return "On Hold";
    }

    function priorityFor(p){
      const st = statusToLabel(p);
      if(st === "Blocked") return "Critical";
      const due = p.dueDate ? new Date(p.dueDate) : null;
      const now = new Date();
      const days = due ? Math.ceil((due - now) / (1000*60*60*24)) : null;
      if(days !== null && days <= 7) return "High";
      if(days !== null && days <= 30) return "Medium";
      return "Low";
    }

    function pad3(n){ return String(n).padStart(3,"0"); }

    function getYearForPRJ(startDate){
      const y = (startDate && String(startDate).length >= 4) ? Number(String(startDate).slice(0,4)) : NaN;
      return Number.isFinite(y) ? y : new Date().getFullYear();
    }

    function normalizePN(s){ return safe(s).trim().toUpperCase(); }

    function parseSeqForType(projectNumber, type, year){
      const pn = normalizePN(projectNumber);
      if(type === "PRJ"){
        const re = new RegExp(`^PRJ-${year}-([0-9]{3})$`);
        const m = pn.match(re);
        return m ? Number(m[1]) : null;
      }
      if(["GR","IT","AP"].includes(type)){
        const re = new RegExp(`^${type}-([0-9]{3})$`);
        const m = pn.match(re);
        return m ? Number(m[1]) : null;
      }
      return null;
    }

    function nextProjectNumber(type, startDate){
      type = normalizePN(type);
      const year = getYearForPRJ(startDate);
      let maxSeq = 0;

      for(const p of projects){
        const seq = parseSeqForType(p.projectNumber, type, year);
        if(seq !== null && seq > maxSeq) maxSeq = seq;
      }

      const next = pad3(maxSeq + 1);

      if(type === "PRJ") return `PRJ-${year}-${next}`;
      if(["GR","IT","AP"].includes(type)) return `${type}-${next}`;
      return `PRJ-${year}-${next}`;
    }

    function isProjectNumberUnique(projectNumber, ignoreProjectId=null){
      const pn = normalizePN(projectNumber);
      return !projects.some(p => normalizePN(p.projectNumber) === pn && p.id !== ignoreProjectId);
    }

    // If any legacy projects are missing a number, assign one
    function migrateLegacyProjectNumbers(){
      projects = projects.map(p=>{
        const type = normalizePN(p.type || "PRJ");
        if(p.projectNumber && normalizePN(p.projectNumber)) return { ...p, type };
        return { ...p, type, projectNumber: nextProjectNumber(type, p.startDate) };
      });
    }

    function buildHoverTasksHTML(projectId){
      const list = tasks
        .filter(t => t.projectId === projectId)
        .sort((a,b)=> (a.dueDate > b.dueDate ? 1 : -1))
        .slice(0,3);

      if(!list.length){
        return `
          <div class="hoverTasks">
            <div class="hoverTitle">Tasks preview</div>
            <div class="hoverItem"><span>No tasks yet</span><span></span></div>
          </div>
        `;
      }

      return `
        <div class="hoverTasks">
          <div class="hoverTitle">Tasks preview</div>
          ${list.map(t=>{
            const p = projects.find(x=>x.id===projectId);
            const pn = p ? normalizePN(p.projectNumber) : "‚Äî";
            return `
              <div class="hoverItem">
                <span><strong>${t.completed ? "‚úì" : "‚Ä¢"}</strong> ${escapeHtml(safe(t.title))}</span>
                <span>${escapeHtml(pn)} ‚Ä¢ ${escapeHtml(fmtDate(t.dueDate))}</span>
              </div>
            `;
          }).join("")}
        </div>
      `;
    }

    /***********************
     * Navigation
     ***********************/
    function showPage(page){
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      document.querySelector(`.tab[data-page="${page}"]`)?.classList.add("active");

      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      document.getElementById(`${page}-page`)?.classList.add("active");

      if(page === "dashboard") renderDashboard();
      if(page === "projects") renderProjectsPage();
      if(page === "tasks"){
        populateProjectSelects();
        renderTasks(getActiveTaskFilter());
      }
    }

    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=> showPage(btn.getAttribute("data-page")));
    });
    document.getElementById("btnTasks").addEventListener("click", ()=> showPage("tasks"));
    document.getElementById("btnNewProject").addEventListener("click", ()=> openProjectModal());
    document.getElementById("btnNewProject2").addEventListener("click", ()=> openProjectModal());
    document.getElementById("btnNewProject2").addEventListener("click", ()=> openProjectModal());

    /***********************
     * Dashboard rendering
     ***********************/
    let statusChart = null;
    let priorityChart = null;

    function tagPriorityClass(p){ return String(p||"").toLowerCase(); }
    function tagStatusClass(s){ return String(s||"").replaceAll(" ","").toLowerCase(); }

    function countsBy(list, getter){
      const out = {};
      for(const item of list){
        const k = getter(item);
        out[k] = (out[k] || 0) + 1;
      }
      return out;
    }

    function dashboardRows(){
      return projects.map(p=>{
        const status = statusToLabel(p);
        const priority = priorityFor(p);
        return {
          projectNumber: normalizePN(p.projectNumber || "‚Äî"),
          name: safe(p.name),
          desc: safe(p.description),
          category: normalizePN(p.type || "PRJ"),
          status,
          priority,
          due: p.dueDate ? fmtDate(p.dueDate) : "‚Äî",
          _rawId: p.id
        };
      });
    }

    function matchesRow(r, search, status){
      const s = (search || "").trim().toLowerCase();
      const text = [r.projectNumber,r.name,r.desc,r.category,r.status,r.priority,r.due].join(" ").toLowerCase();
      const okSearch = s==="" || text.includes(s);
      const okStatus = status==="All" || r.status === status;
      return okSearch && okStatus;
    }

    function renderDashboard(){
      const rows = dashboardRows();

      const total = rows.length;
      const completed = rows.filter(r=>r.status==="Completed").length;
      const inProgress = rows.filter(r=>r.status==="In Progress").length;
      const blocked = rows.filter(r=>r.status==="Blocked").length;
      const completionRate = total ? Math.round((completed/total)*100) : 0;

      document.getElementById("kpiTotal").textContent = total;
      document.getElementById("kpiCompleted").textContent = completed;
      document.getElementById("kpiInProgress").textContent = inProgress;
      document.getElementById("kpiBlocked").textContent = blocked;
      document.getElementById("kpiCompletion").textContent = `${completionRate}% completion rate`;

      // Table
      const search = document.getElementById("searchInput").value;
      const statusF = document.getElementById("statusFilter").value;
      const filtered = rows.filter(r=>matchesRow(r, search, statusF));

      const body = document.getElementById("projectsBody");
      body.innerHTML = filtered.map(r=>{
        return `
          <tr class="row" data-project="${r._rawId}">
            <td><a href="#" class="idLink">${escapeHtml(r.projectNumber)}</a></td>
            <td>
              <div class="hoverWrap">
                <div style="font-weight:900">${escapeHtml(r.name)}</div>
                <div class="desc">${escapeHtml(r.desc)}</div>
                ${buildHoverTasksHTML(r._rawId)}
              </div>
            </td>
            <td>${escapeHtml(r.category)}</td>
            <td><span class="tag ${tagPriorityClass(r.priority)}">${escapeHtml(r.priority)}</span></td>
            <td><span class="tag status ${tagStatusClass(r.status)}">${escapeHtml(r.status)}</span></td>
            <td>${escapeHtml(r.due)}</td>
          </tr>
        `;
      }).join("");

      body.querySelectorAll("tr.row").forEach(tr=>{
        tr.addEventListener("click",(e)=>{
          e.preventDefault();
          const id = Number(tr.getAttribute("data-project"));
          setTaskProjectFilter(id);
        });
      });

      // Charts
      const statusCounts = countsBy(rows, r=>r.status);
      const priorityCounts = countsBy(rows, r=>r.priority);

      const statusLabels = ["Completed","In Progress","Not Started","On Hold","Blocked"];
      const statusValues = statusLabels.map(l=>statusCounts[l] || 0);

      const prioLabels = ["Critical","High","Medium","Low"];
      const prioValues = prioLabels.map(l=>priorityCounts[l] || 0);

      if(statusChart) statusChart.destroy();
      if(priorityChart) priorityChart.destroy();

      statusChart = new Chart(document.getElementById("statusChart"), {
        type: "doughnut",
        data: { labels: statusLabels, datasets:[{ data: statusValues }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
      });

      priorityChart = new Chart(document.getElementById("priorityChart"), {
        type: "bar",
        data: { labels: prioLabels, datasets:[{ data: prioValues }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
      });
    }

    document.getElementById("searchInput").addEventListener("input", renderDashboard);
    document.getElementById("statusFilter").addEventListener("change", renderDashboard);

    /***********************
     * Projects page
     ***********************/
    function renderProjectsPage(){
      const grid = document.getElementById("projectsGrid");
      if(!projects.length){
        grid.innerHTML = `<div class="card"><div class="muted">No projects yet.</div></div>`;
        return;
      }

      grid.innerHTML = projects.map(p=>{
        const pn = normalizePN(p.projectNumber || "‚Äî");
        const statusLabel = statusToLabel(p);
        const priority = priorityFor(p);

        return `
          <div class="card hoverWrap" data-pcard="${p.id}">
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
              <div>
                <div style="font-family:'Sora',sans-serif;font-weight:900">${escapeHtml(p.name)}</div>
                <div class="muted" style="font-size:12px;margin-top:3px;">üìå <strong>${escapeHtml(pn)}</strong> ‚Ä¢ ${escapeHtml(p.type || "PRJ")} ‚Ä¢ ${escapeHtml(p.client || "‚Äî")}</div>
                <div class="muted" style="font-size:12px;margin-top:6px;">Due: <strong>${escapeHtml(fmtDate(p.dueDate))}</strong></div>
                <div class="muted" style="font-size:12px;margin-top:6px;">${escapeHtml(p.description || "")}</div>
              </div>
              <div style="display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap;">
                <span class="tag ${tagPriorityClass(priority)}">${escapeHtml(priority)}</span>
                <span class="tag status ${tagStatusClass(statusLabel)}">${escapeHtml(statusLabel)}</span>
              </div>
            </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
              <button class="btnMini" data-pact="tasks">‚úì View Tasks</button>
              <button class="btnMini" data-pact="edit">‚úè Edit</button>
              <button class="btnMini" data-pact="delete">üóë Delete</button>
            </div>

            ${buildHoverTasksHTML(p.id)}
          </div>
        `;
      }).join("");

      grid.querySelectorAll('[data-pcard]').forEach(card=>{
        const pid = Number(card.getAttribute("data-pcard"));
        card.querySelectorAll('button[data-pact]').forEach(btn=>{
          btn.addEventListener("click",(e)=>{
            e.stopPropagation();
            const act = btn.getAttribute("data-pact");
            if(act==="tasks") setTaskProjectFilter(pid);
            if(act==="edit") openProjectModal(pid);
            if(act==="delete") deleteProject(pid);
          });
        });
      });
    }

    function deleteProject(projectId){
      const p = projects.find(x=>x.id===projectId);
      const pn = p ? normalizePN(p.projectNumber) : "";
      const ok = confirm(`Delete project ${pn ? pn + " - " : ""}${p ? p.name : ""}?\n\nThis will also remove its tasks.`);
      if(!ok) return;

      projects = projects.filter(x=>x.id!==projectId);
      tasks = tasks.filter(t=>t.projectId!==projectId);
      persist();
      populateProjectSelects();
      renderDashboard();
      renderProjectsPage();
      renderTasks(getActiveTaskFilter());
    }

    /***********************
     * Tasks page
     ***********************/
    let currentProjectFilterId = null;

    function populateProjectSelects(){
      const selects = [document.getElementById("taskProject"), document.getElementById("tmProject")].filter(Boolean);
      const options = projects.map(p=>{
        const pn = normalizePN(p.projectNumber || "");
        return `<option value="${p.id}">${escapeHtml(pn)} ‚Äî ${escapeHtml(p.name)}</option>`;
      }).join("");
      selects.forEach(sel=> sel.innerHTML = options || `<option value="">No projects</option>`);
    }

    function setTaskProjectFilter(projectId){
      currentProjectFilterId = projectId;
      const p = projects.find(x=>x.id===projectId);

      const subtitle = document.getElementById("tasksSubtitle");
      const btnShowAll = document.getElementById("btnShowAll");

      if(p){
        const pn = normalizePN(p.projectNumber || "‚Äî");
        subtitle.textContent = `Showing tasks for: ${pn} ‚Äî ${p.name}`;
        btnShowAll.style.display = "inline-flex";
      }else{
        subtitle.textContent = "Track and update your work items";
        btnShowAll.style.display = "none";
      }

      showPage("tasks");
      populateProjectSelects();
      document.getElementById("taskFilter").value = "all";
      renderTasks("all");
    }

    document.getElementById("btnShowAll").addEventListener("click", ()=>{
      currentProjectFilterId = null;
      document.getElementById("tasksSubtitle").textContent = "Track and update your work items";
      document.getElementById("btnShowAll").style.display = "none";
      renderTasks(getActiveTaskFilter());
    });

    function getActiveTaskFilter(){
      return document.getElementById("taskFilter").value || "all";
    }
    document.getElementById("taskFilter").addEventListener("change", ()=> renderTasks(getActiveTaskFilter()));

    function renderTasks(filter="all"){
      const host = document.getElementById("tasksGrid");
      let list = [...tasks];

      if(currentProjectFilterId){
        list = list.filter(t=>t.projectId===currentProjectFilterId);
      }

      if(filter==="open") list = list.filter(t=>!t.completed);
      if(filter==="completed") list = list.filter(t=>t.completed);
      if(filter==="due-today") list = list.filter(t=>isDueToday(t));
      if(filter==="overdue") list = list.filter(t=>isOverdue(t));

      if(!list.length){
        host.innerHTML = `<div class="card"><div class="muted">No tasks found for this filter.</div></div>`;
        return;
      }

      host.innerHTML = list
        .sort((a,b)=> (a.dueDate > b.dueDate ? 1 : -1))
        .map(t=>{
          const p = projects.find(x=>x.id===t.projectId);
          const pn = p ? normalizePN(p.projectNumber) : "‚Äî";
          const pName = p ? p.name : "Unassigned";
          const badges = [
            `<span class="badge">üìå ${escapeHtml(pn)}</span>`,
            `<span class="badge">üìÅ ${escapeHtml(pName)}</span>`
          ];
          if(isDueToday(t)) badges.push(`<span class="badge today">üìÖ Due today</span>`);
          if(isOverdue(t)) badges.push(`<span class="badge overdue">‚ö† Overdue</span>`);

          return `
            <div class="card" data-task="${t.id}">
              <div class="taskRow">
                <input class="taskCheck" type="checkbox" ${t.completed ? "checked":""} aria-label="Mark complete" />
                <div style="flex:1;">
                  <div class="taskTitle ${t.completed ? "done":""}">${escapeHtml(safe(t.title))}</div>
                  <div class="muted" style="font-size:12px;">Due: <strong>${escapeHtml(fmtDate(t.dueDate))}</strong></div>
                  <div class="badges">${badges.join("")}</div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
                    <button class="btnMini" data-act="edit">‚úè Edit</button>
                    <button class="btnMini" data-act="delete">üóë Delete</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("");

      // actions
      host.querySelectorAll('[data-task]').forEach(card=>{
        const taskId = Number(card.getAttribute("data-task"));
        card.querySelector(".taskCheck").addEventListener("change", (e)=>{
          tasks = tasks.map(x=> x.id===taskId ? {...x, completed: e.target.checked} : x);
          persist();
          renderDashboard(); renderProjectsPage(); renderTasks(getActiveTaskFilter());
        });

        card.querySelectorAll('button[data-act]').forEach(btn=>{
          btn.addEventListener("click", (e)=>{
            e.stopPropagation();
            const act = btn.getAttribute("data-act");
            if(act==="edit") openTaskModal(taskId);
            if(act==="delete") deleteTask(taskId);
          });
        });
      });
    }

    document.getElementById("addTaskForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const title = document.getElementById("taskTitle").value.trim();
      const dueDate = document.getElementById("taskDue").value;
      const projectId = Number(document.getElementById("taskProject").value);

      if(!title) return;
      tasks.unshift({ id: Date.now(), title, projectId, dueDate, completed:false });
      persist();

      e.target.reset();
      renderTasks(getActiveTaskFilter());
      renderDashboard();
      renderProjectsPage();
    });

    document.getElementById("btnClearCompleted").addEventListener("click", ()=>{
      tasks = tasks.filter(t=>!t.completed);
      persist();
      renderTasks(getActiveTaskFilter());
      renderDashboard();
      renderProjectsPage();
    });

    function deleteTask(taskId){
      const t = tasks.find(x=>x.id===taskId);
      const ok = confirm(`Delete task "${t ? t.title : ""}"?`);
      if(!ok) return;
      tasks = tasks.filter(x=>x.id!==taskId);
      persist();
      renderTasks(getActiveTaskFilter());
      renderDashboard();
      renderProjectsPage();
    }

    /***********************
     * Task modal (edit)
     ***********************/
    const taskModal = document.getElementById("taskModal");
    let editingTaskId = null;

    function openTaskModal(taskId){
      const t = tasks.find(x=>x.id===taskId);
      if(!t) return;
      editingTaskId = taskId;

      document.getElementById("tmTaskTitle").value = t.title;
      document.getElementById("tmDue").value = t.dueDate;

      populateProjectSelects();
      document.getElementById("tmProject").value = String(t.projectId);

      taskModal.classList.add("show");
    }
    function closeTaskModal(){
      taskModal.classList.remove("show");
      editingTaskId = null;
    }
    document.getElementById("tmCancel").addEventListener("click", closeTaskModal);
    taskModal.addEventListener("click",(e)=>{ if(e.target===taskModal) closeTaskModal(); });

    document.getElementById("tmSave").addEventListener("click", ()=>{
      if(!editingTaskId) return;
      const title = document.getElementById("tmTaskTitle").value.trim();
      const due = document.getElementById("tmDue").value;
      const projectId = Number(document.getElementById("tmProject").value);

      tasks = tasks.map(x=> x.id===editingTaskId ? {...x, title: title || x.title, dueDate: due || x.dueDate, projectId } : x);
      persist();
      closeTaskModal();
      renderTasks(getActiveTaskFilter());
      renderDashboard();
      renderProjectsPage();
    });

    /***********************
     * Project modal (create/edit) with sequential auto-numbering + uniqueness enforcement
     ***********************/
    const projectModal = document.getElementById("projectModal");
    let editingProjectId = null;

    function openProjectModal(projectId=null){
      editingProjectId = projectId;
      document.getElementById("pmTitle").textContent = projectId ? "Edit Project" : "New Project";

      const p = projectId ? projects.find(x=>x.id===projectId) : null;

      document.getElementById("pmType").value = p?.type || "PRJ";
      document.getElementById("pmStart").value = p?.startDate || "";
      document.getElementById("pmDue").value = p?.dueDate || "";

      // Auto-fill a suggested number if new
      if(p?.projectNumber){
        document.getElementById("pmNumber").value = normalizePN(p.projectNumber);
      }else{
        document.getElementById("pmNumber").value = nextProjectNumber(document.getElementById("pmType").value, document.getElementById("pmStart").value);
      }

      document.getElementById("pmName").value = p?.name || "";
      document.getElementById("pmClient").value = p?.client || "";
      document.getElementById("pmStatus").value = p?.status || "active";
      document.getElementById("pmDesc").value = p?.description || "";

      projectModal.classList.add("show");
      setTimeout(()=> document.getElementById("pmName").focus(), 50);
    }
    function closeProjectModal(){
      projectModal.classList.remove("show");
      editingProjectId = null;
    }
    document.getElementById("pmCancel").addEventListener("click", closeProjectModal);
    projectModal.addEventListener("click",(e)=>{ if(e.target===projectModal) closeProjectModal(); });

    // When type/start date changes, update suggested number ONLY if user hasn't typed a custom value
    function refreshSuggestedNumber(){
      const input = document.getElementById("pmNumber");
      const current = normalizePN(input.value);
      const type = document.getElementById("pmType").value;
      const start = document.getElementById("pmStart").value;

      // If editing an existing project, don't auto-overwrite unless empty
      if(editingProjectId){
        if(!current){
          input.value = nextProjectNumber(type, start);
        }
        return;
      }

      // New project: always set suggestion if field empty OR equals previous suggestion format
      input.value = nextProjectNumber(type, start);
    }
    document.getElementById("pmType").addEventListener("change", refreshSuggestedNumber);
    document.getElementById("pmStart").addEventListener("change", refreshSuggestedNumber);

    document.getElementById("pmSave").addEventListener("click", ()=>{
      const name = document.getElementById("pmName").value.trim();
      if(!name) return alert("Project name is required.");

      const type = normalizePN(document.getElementById("pmType").value || "PRJ");
      const startDate = document.getElementById("pmStart").value;
      const dueDate = document.getElementById("pmDue").value;

      let projectNumber = normalizePN(document.getElementById("pmNumber").value);
      if(!projectNumber){
        projectNumber = nextProjectNumber(type, startDate);
      }

      // Validate format
      const year = getYearForPRJ(startDate);
      const okFormat =
        (type==="PRJ" && new RegExp(`^PRJ-${year}-[0-9]{3}$`).test(projectNumber)) ||
        (["GR","IT","AP"].includes(type) && new RegExp(`^${type}-[0-9]{3}$`).test(projectNumber));

      if(!okFormat){
        const example = type==="PRJ" ? `PRJ-${year}-001` : `${type}-001`;
        return alert(`Invalid project number format for ${type}. Example: ${example}`);
      }

      if(!isProjectNumberUnique(projectNumber, editingProjectId)){
        return alert(`Project number already exists: ${projectNumber}. Please use a unique number.`);
      }

      const payload = {
        type,
        projectNumber,
        name,
        client: document.getElementById("pmClient").value.trim(),
        status: document.getElementById("pmStatus").value,
        startDate,
        dueDate,
        description: document.getElementById("pmDesc").value.trim()
      };

      if(editingProjectId){
        projects = projects.map(p=> p.id===editingProjectId ? {...p, ...payload} : p);
      }else{
        const newId = Date.now();
        projects.unshift({ id: newId, ...payload });
      }

      persist();
      closeProjectModal();

      populateProjectSelects();
      renderDashboard();
      renderProjectsPage();
      renderTasks(getActiveTaskFilter());
      showPage("projects");
    });

    /***********************
     * Boot
     ***********************/
    function ensureValid(){
      if(!Array.isArray(projects)) projects = [...defaultProjects];
      if(!Array.isArray(tasks)) tasks = [...defaultTasks];

      migrateLegacyProjectNumbers();

      // Remove tasks that reference missing projects
      const ids = new Set(projects.map(p=>p.id));
      tasks = tasks.filter(t=>ids.has(t.projectId));

      persist();
    }

    window.addEventListener("load", ()=>{
      ensureValid();
      populateProjectSelects();
      renderDashboard();
      renderProjectsPage();
      renderTasks(getActiveTaskFilter());
    });
  </script>
</body>
</html>
